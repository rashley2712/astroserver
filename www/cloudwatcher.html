<html>
    <head>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-52663594-2"></script>
        <script language="javascript" type="text/javascript" src="astro.js-master/astro.js"></script>
		<script language="javascript" type="text/javascript" src="astro.js-master/astro.constants.js"></script>
		<script language="javascript" type="text/javascript" src="astro.js-master/astro.dates.js"></script>
        <script language="javascript" type="text/javascript" src="astro.js-master/astro.ephem.js"></script>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'UA-52663594-2');
        </script>
        
        <title>AstroFarm, Weather information</title>
        <link rel="stylesheet" type="text/css" href="styles.css"/>
     	
        <script src="astrotools.js"></script>
        
        <script language="Javascript">
            function getCSV(url, callback) {
                var xhr = new XMLHttpRequest();
                    xhr.open('GET', url, true);
                    // xhr.responseType = 'json';
                    xhr.onload = function() {
                        var status = xhr.status;
                        if (status === 200) {
                            callback(null, xhr.response);
                        } else {
                            callback(status, xhr.response);
                        }
                    };
                xhr.send();
            };    

            // Global variables
            var currentTime = new Date();
            var secondsTimerId = null;
            var minutesTimerId = null;
            var cloudData = {};
            var dayData = null;
            var chartDate = "20200731";
            var availableDates = [];
            var currentDateIndex = -1;
            var chartLoaded = false;
            var chart;
            console.log(currentTime);
            
            // Import Google Charts
            google.charts.load('current', {'packages':['corechart', 'timeline']});
            google.charts.setOnLoadCallback(function() { chartLoaded = true;});

            // Call a function only when the page is fully loaded.
		    document.addEventListener('readystatechange', event => {
		        if (event.target.readyState === "complete") {
			        onLoad();
		        }
		    });
                
            function onLoad() {
                console.log("The page has loaded....");
                getCSV('userdata.csv', parseCSV);
                 
            }

            function parseField(field, type) {
                if (!field) return null;
                var valueStr = field.replace(/['"]+/g, '');
                if (type=="float") return parseFloat(valueStr);
                else return valueStr;    
                    
            }

            function combineDateTime(cloudData) {
                cloudData.dateTime = [];
                for (var i in cloudData.Date) {
                    var dateString = cloudData.Date[i] + " " + cloudData.Time[i];
                    var unixTime = Date.parse(dateString);
                    var newDate = new Date(unixTime);
                    cloudData.dateTime.push(newDate);
                    }
                // Search for the dateBreaks and update the times
                var beginTime = cloudData.dateTime[0];
                var startTime = beginTime;
                var dateBroken = false;
                var counter = 0;
                for (var i=0; i<cloudData.dateTime.length; i++) {
                    cloudField = cloudData['Cloud Condition'][i];
                    var advance = cloudData.dateTime[i] - beginTime;
                    var newTime = new Date(advance + startTime.getTime());
                    if (cloudField=='DateBreak') {
                        startTime = cloudData.dateTime[i];
                        beginTime = cloudData.dateTime[i+1];
                        console.log("DateBreak in line:", i);
                        dateBroken = true;
                        continue;
                    }
                 
                    cloudData.dateTime[i] = newTime;

                }
                console.log(cloudData);
            }

            function parseCSV(err, data) {
                console.log("Got CSV data");
                lines = data.split('\n');
                headers = lines.shift().split(",");
                console.log(headers);
                var headerArray = [];
                for (h of headers) { 
                    key = h.replace(/['"]+/g, '');
                    headerArray.push(key);
                    cloudData[key] = [];
                }
                for (line of lines) {
                    if (line.length < 3) continue;
                    fields = line.split(",");
                    cloudData[headerArray[0]].push(parseField(fields[0], "string"));    
                    cloudData[headerArray[1]].push(parseField(fields[1], "string"));
                    cloudData[headerArray[2]].push(parseField(fields[2], "string"));
                        
                    cloudData[headerArray[5]].push(parseField(fields[5], "float"));
                }
                console.log(cloudData);

                combineDateTime(cloudData);
                dayData = groupIntoDays(cloudData);
                drawChart(chartDate);
               
           }

           function groupIntoDays(cloudData) {
                var uniqueDates = [];
                for (var i=0; i<cloudData.dateTime.length; i++) {
                    var dateTimeValue = cloudData.dateTime[i];
                    dateString = formatDate(dateTimeValue);
                    if (!uniqueDates.includes(dateString)) uniqueDates.push(dateString);
                }
                console.log("unique dates:", uniqueDates);
                availableDates = uniqueDates;
                dayData = {};
                for (d of uniqueDates) {
                    dayData[d] = {};
                    var dateTimes = [];
                    var skyTemps = [];
                    for (var i=0; i<cloudData.dateTime.length; i++) {
                        var dateTimeValue = cloudData.dateTime[i];
                        dateString = formatDate(dateTimeValue);
                        if (dateString==d) {
                            dateTimes.push(dateTimeValue);
                            skyTemps.push(cloudData['Cloud Value'][i]);
                        }
                    }
                    dayData[d]['dateTime'] = dateTimes;
                    dayData[d]['skyTemp'] = skyTemps;

                }
                console.log("Day data:", dayData);
                return dayData;
            }

      

            function drawChart() {
                if (currentDateIndex == -1) currentDateIndex = availableDates.length -1;
                if (!chartLoaded) {
                    console.log("Google stuff not loaded! Will try again in 1 second...");
                    setTimeout(drawChart, 1000, dateString);
                    return;
                } else {
                    console.log("Google charts are ready.");
                }

                dateString = availableDates[currentDateIndex];
                chartDate = dateString;
                todaysData = dayData[dateString];
                console.log("Today's data", todaysData);
                
                var data = new google.visualization.DataTable();
                data.addColumn('datetime', 'Time of day');
                data.addColumn('number', 'Sky temperature');
                
                for (var i=0; i<todaysData.dateTime.length; i++) {
                    var dateObject = new Date(todaysData.dateTime[i].getYear()+1900, todaysData.dateTime[i].getMonth()+1, todaysData.dateTime[i].getDate());
                    data.addRow([todaysData.dateTime[i], parseFloat(todaysData.skyTemp[i])]);
                    console.log(typeof dateObject)
                }
                

                var options = {
                title: 'Sky temperature for ' + dateString,
                hAxis: {title: 'Time'},
                vAxis: {title: 'Sky Temperature (C)'},
                legend: 'none'
                };

                chart = new google.visualization.ScatterChart(document.getElementById('chart_div'));  
                chart.draw(data, options);
                document.getElementById('chartDate').innerText = chartDate;
            }

            function shiftDay(amount) {
                console.log("Shift day by", amount);
                currentDateIndex = currentDateIndex + amount;
                if (currentDateIndex == availableDates.length) {
                    currentDateIndex--;
                    return;
                }
                drawChart();
            }
  

</script>
</head>

<body>
    
    <h1>AstroFarm</h1>
    <h2>La Palma</h2>
    <p>site conditions</p>
    <table>
        <tr>
            <td><a onclick="shiftDay(-1)">&lt;&lt;</a></td>
            <td><span id="chartDate">date</span></td>
            <td><a onclick="shiftDay(1)">&gt;&gt;</a></td>
        </tr>
    </table>
    <div id="chart_div" style="width: 900px; height: 500px;"></div>
  
    <p id='footer'>
    <span id="hostname">unknown</span>&nbsp;&nbsp;<span id="uptime">&nbsp;</span>
    </p>
</body>
<!--  style="border:1px solid #ffffff;-->
</html>
