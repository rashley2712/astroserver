<html>
    <head>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-52663594-2"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'UA-52663594-2');
        </script>
        
        <title>AstroFarm, La Palma</title>
        <link rel="stylesheet" type="text/css" href="styles.css"/>
     	
        <script src="astrotools.js"></script>
        
        <script language="Javascript">
            function getJSON(url, callback) {
                var xhr = new XMLHttpRequest();
                    xhr.open('GET', url, true);
                    xhr.responseType = 'json';
                    xhr.onload = function() {
                        var status = xhr.status;
                        if (status === 200) {
                            callback(null, xhr.response);
                        } else {
                            callback(status, xhr.response);
                        }
                    };
                xhr.send();
            };    

            // Global variables
            var currentTime = new Date();
            var clockID = null;
            var constellation = null;
            var clockAngle = 0;
            console.log(currentTime);
            
            // Call a function only when the page is fully loaded.
		    document.addEventListener('readystatechange', event => {
		        if (event.target.readyState === "complete") {
			        onLoad();
		        }
		    });
  
              
            function onLoad() {
                console.log("The page has loaded....");
                getJSON('info', info);
                getJSON('ursaminor.json', starsLoaded)
                clockID = setInterval(updateClock, 1000);
            }

            window.onload = window.onresize = function() {
                var canvas = document.getElementById('canvasContainer');
                var canvasWidth = document.getElementById('canvas').width;
                canvas.style.top = 20;
                canvas.style.left = window.innerWidth - canvasWidth - 10;
                console.log("resized");
            }

           
       
            function info(err, data) {
                console.log(data);
                document.getElementById("hostname").innerText = data.system.hostname;
                document.getElementById("uptime").innerText = "uptime: " + data.system.uptime + "s";
                document.getElementById("moonphase").innerText = decimalPlacesString(data.moon.illuminated, 2) + "  " + data.moon.mode;
                document.getElementById("etwilight").innerText = data.sun.etwilight;
                document.getElementById("mtwilight").innerText = data.sun.mtwilight;
                document.getElementById("sunset").innerText = data.sun.sunset;
                document.getElementById("sunrise").innerText = data.sun.sunrise;
                document.getElementById('currentUTC').innerText = formatUTCTime(currentTime);
            }

            function updateClock() {
                currentTime = new Date();
                document.getElementById('currentUTC').innerText = formatUTCTime(currentTime);
                clockAngle+=1;
                drawClock();
            }

            function starsLoaded(err, data) {
                if (err!=null) { console.log(err);}
                console.log("Constellation", data);
                constellation = data;
                drawClock();

            }

            function drawClock() {
                const quiet = true;
                var canvas = document.getElementById("canvas");
                
                var ctx = canvas.getContext("2d");
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(document.getElementById('cross'), canvas.width/2, canvas.height/2);
                var stars = constellation.stars;
                const size = canvas.width/2/(90-70);
                for (s of stars) {
                    if (!quiet) console.log(s.name, s.coordinates.RA, s.coordinates.DEC);
                    var coords = s.coordinates.RA + " " +  s.coordinates.DEC;
                    var result = fromSexagesimalString(coords);
                    if (!quiet) console.log(result);
                    var r = Math.sin(radians(result.dec)) * size * (90 - result.dec);   // The first term is to correct for the projection on to a flat plane
                    var angle = clockAngle + result.ra;
                    var x = canvas.width/2 + r * Math.sin(radians(angle));
                    var y = canvas.height/2 - r * Math.cos(radians(angle));
                    if (!quiet) console.log(x, y)
                    ctx.drawImage(document.getElementById('star'), x, y);
                }
            }

      
  

</script>
</head>

<body>
    
    <h1>AstroFarm</h1>
    <h2>La Palma</h2>
    <p><a href="https://goo.gl/maps/B5QmqDhPithRyyS38" target="_new">28°47'09.8"N 17°56'05.0"W</a> (altitude: 1153m)</p>
    <p>
        <table border="1">
            <tr>
                <td style="font-weight: bold;">Current UTC</td><td><span id="currentUTC">&nbsp;</span></td>
            </tr>
            <tr>
                <td style="font-weight: bold;">Current moon phase</td><td><span id="moonphase">&nbsp;</span></td>
            </tr>
            <tr>
                <td style="font-weight: bold;">Sunset</td><td><span id="sunset">&nbsp;</span></td>
            </tr>
            <tr>
                <td style="font-weight: bold;">Evening twilight</td><td><span id="etwilight">&nbsp;</span></td>
            </tr>
            <tr>
                <td style="font-weight: bold;">Morning twilight</td><td><span id="mtwilight">&nbsp;</span></td>
            </tr>
            <tr>
                <td style="font-weight: bold;">Sunrise</td><td><span id="sunrise">&nbsp;</span></td>
            </tr>
        </table>
    </p>

    <div id='canvasContainer' style="position:absolute; top:0; left:0; z-index:1">  
    <canvas id="canvas" width="500" height="500"></canvas>
    </div>  
    <div style="display:none;"><img id="star" src="images/star.png"></div>
    <div style="display:none;"><img id="cross" src="images/cross.png"></div>
  
    <p id='footer'>
    <span id="hostname">unknown</span>&nbsp;&nbsp;<span id="uptime">&nbsp;</span>
    </p>
</body>
<!--  style="border:1px solid #ffffff;-->
</html>
